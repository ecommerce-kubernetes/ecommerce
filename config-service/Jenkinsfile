pipeline {
    agent any

    environment {
        GIT_REPO = 'https://github.com/ecommerce-kubernetes/ecommerce.git'
        BRANCH = 'develop'
        TARGET_DIR = 'config-service'
        SSH_CREDENTIALS_ID = 'ansible-key'
        REMOTE_HOST = '172.18.0.11'
        REMOTE_USER = 'root'
        REMOTE_PATH = '/ansible/playbooks/config-playbook'
    }

    stages {
        stage('SCM Checkout (with Sparse Path)') {
            steps {
                echo '📥 config-service 디렉토리만 sparse checkout 중...'

                checkout([$class: 'GitSCM',
                    branches: [[name: "*/${BRANCH}"]],
                    userRemoteConfigs: [[
                        url: "${GIT_REPO}",
                        credentialsId: 'github_access_token'
                    ]],
                    extensions: [
                        [$class: 'SparseCheckoutPaths',
                            sparseCheckoutPaths: [[path: "${TARGET_DIR}"]]
                        ],
                        [$class: 'CleanCheckout']
                    ]
                ])
            }
        }

        stage('Check Changes') {
            steps {
                script {
                    if (!hasChangesIn("${TARGET_DIR}")) {
                        echo "✅ 변경 사항 없음. 이후 단계 생략."
                        currentBuild.description = "🟢 변경 없음, 스킵됨"
                        catchError(buildResult: 'SUCCESS', stageResult: 'SUCCESS') {
                            error("🎯 변경 사항 없음. 파이프라인 종료")
                        }
                    } else {
                        echo "📂 변경 사항 감지됨. 계속 진행합니다."
                    }
                }
            }
        }

        stage('Gradle Build') {
            steps {
                echo '⚙️ Gradle 빌드 시작'
                dir("${TARGET_DIR}") {
                    withCredentials([usernamePassword(credentialsId: 'github_access_token', usernameVariable: 'GITHUB_USERNAME', passwordVariable: 'GITHUB_TOKEN')]) {
                        sh '''
                            chmod +x gradlew
                            GITHUB_USERNAME=$GITHUB_USERNAME GITHUB_TOKEN=$GITHUB_TOKEN ./gradlew clean build
                        '''
                    }
                }
            }
        }

        stage('Copy to Ansible Server') {
            steps {
                echo '🚚 Ansible 서버로 JAR 파일 복사 중...'
                script {
                    def jarFiles = findFiles(glob: "${TARGET_DIR}/build/libs/*.jar")
                    def targetJar = jarFiles.find { file ->
                        !file.name.contains("plain") && file.name.endsWith(".jar")
                    }

                    if (targetJar) {
                        echo "📦 복사할 JAR 파일: ${targetJar.name}"
                        sshagent (credentials: ["${SSH_CREDENTIALS_ID}"]) {
                            // 1. 기존 JAR 파일 삭제
                            sh """
                                ssh -o StrictHostKeyChecking=no ${REMOTE_USER}@${REMOTE_HOST} \\
                                'rm -f ${REMOTE_PATH}/*.jar'
                            """

                            // 2. 새 JAR 파일을 이름을 바꿔서 복사 (discovery-service.jar)
                            sh """
                                scp -o StrictHostKeyChecking=no ${targetJar.path} ${REMOTE_USER}@${REMOTE_HOST}:${REMOTE_PATH}/config-service.jar
                            """
                        }
                    } else {
                        error("❌ plain이 아닌 JAR 파일을 찾을 수 없습니다.")
                    }
                }
            }
        }

        stage('Run Ansible Playbook') {
            steps {
                echo '🚀 Ansible 플레이북 실행 중...'
                sshagent (credentials: ["${SSH_CREDENTIALS_ID}"]) {
                    sh """
                        ssh -o StrictHostKeyChecking=no ${REMOTE_USER}@${REMOTE_HOST} \\
                        'ansible-playbook -i /ansible/inventory/hosts /ansible/playbooks/config-playbook/config-playbook.yml'
                    """
                }
            }
        }
    }

    post {
        success {
            echo '✅ config-service 배포 완료!'
        }
        failure {
            echo '❌ 빌드 또는 배포 실패!'
        }
    }
}

def hasChangesIn(String dir) {
    def previous = env.GIT_PREVIOUS_SUCCESSFUL_COMMIT ?: 'HEAD~1'
    def current = env.GIT_COMMIT
    return sh(
        script: "git diff --name-only ${previous} ${current} | grep ^${dir}/ || true",
        returnStdout: true
    ).trim() != ""
}

