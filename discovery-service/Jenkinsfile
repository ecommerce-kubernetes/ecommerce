pipeline {
    agent any

    environment {
        GIT_REPO = 'https://github.com/ecommerce-kubernetes/ecommerce.git'
        BRANCH = 'develop'
        TARGET_DIR = 'discovery-service'
        SSH_CREDENTIALS_ID = 'ansible-key'
        REMOTE_HOST = '172.18.0.11'
        REMOTE_USER = 'root'
        REMOTE_PATH = '/ansible/playbooks/discovery-playbook'
    }

    triggers {
        // GitHub webhookì´ ì‘ë™í•˜ì§€ ì•Šì„ ë•Œ Poll SCM ë°±ì—…
        pollSCM('H/2 * * * *')
    }

    stages {
        stage('SCM Checkout (with Sparse Path)') {
            steps {
                echo 'ğŸ“¥ discovery-service ë””ë ‰í† ë¦¬ë§Œ sparse checkout ì¤‘...'

                checkout([$class: 'GitSCM',
                    branches: [[name: "*/${BRANCH}"]],
                    userRemoteConfigs: [[
                        url: "${GIT_REPO}",
                        credentialsId: 'github_access_token'
                    ]],
                    extensions: [
                        [$class: 'SparseCheckoutPaths',
                            sparseCheckoutPaths: [[path: "${TARGET_DIR}"]]
                        ],
                        [$class: 'CleanCheckout']
                    ]
                ])
            }
        }

        stage('Check Changes') {
            steps {
                script {
                    if (!hasChangesIn("${TARGET_DIR}")) {
                        echo "âœ… ${TARGET_DIR}ì— ë³€ê²½ ì‚¬í•­ ì—†ìŒ. ì´í›„ ë‹¨ê³„ ìƒëµí•˜ê³  íŒŒì´í”„ë¼ì¸ ì •ìƒ ì¢…ë£Œí•©ë‹ˆë‹¤."
                        currentBuild.result = 'SUCCESS'
                        // íŒŒì´í”„ë¼ì¸ì„ ì¢…ë£Œì‹œí‚¤ê¸° ìœ„í•œ ê°•ì œ ì—ëŸ¬ ì²˜ë¦¬
                        // í•˜ì§€ë§Œ ì‹¤ì œë¡œëŠ” ì‹¤íŒ¨ê°€ ì•„ë‹ˆë¼ ì„±ê³µì²˜ëŸ¼ ë³´ì—¬ì§€ê²Œ í•¨
                        catchError(buildResult: 'SUCCESS', stageResult: 'SUCCESS') {
                            error("ğŸ¯ ë³€ê²½ ì‚¬í•­ì´ ì—†ìœ¼ë¯€ë¡œ íŒŒì´í”„ë¼ì¸ ì¢…ë£Œ")
                        }
                    } else {
                        echo "ğŸ“‚ ë³€ê²½ ì‚¬í•­ ê°ì§€ë¨. ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤."
                    }
                }
            }
        }

        stage('Gradle Build') {
            steps {
                echo 'âš™ï¸ Gradle ë¹Œë“œ ì‹œì‘'
                dir("${TARGET_DIR}") {
                    sh '''
                        chmod +x gradlew
                        ./gradlew clean build
                    '''
                }
            }
        }

        stage('Copy to Ansible Server') {
            steps {
                echo 'ğŸšš Ansible ì„œë²„ë¡œ JAR íŒŒì¼ ë³µì‚¬ ì¤‘...'
                script {
                    def jarFiles = findFiles(glob: "${TARGET_DIR}/build/libs/*.jar")
                    def targetJar = jarFiles.find { file ->
                        !file.name.contains("plain") && file.name.endsWith(".jar")
                    }

                    if (targetJar) {
                        echo "ğŸ“¦ ë³µì‚¬í•  JAR íŒŒì¼: ${targetJar.name}"
                        sshagent (credentials: ["${SSH_CREDENTIALS_ID}"]) {
                            // 1. ê¸°ì¡´ JAR íŒŒì¼ ì‚­ì œ
                            sh """
                                ssh -o StrictHostKeyChecking=no ${REMOTE_USER}@${REMOTE_HOST} \\
                                'rm -f ${REMOTE_PATH}/*.jar'
                            """

                            // 2. ìƒˆ JAR íŒŒì¼ì„ ì´ë¦„ì„ ë°”ê¿”ì„œ ë³µì‚¬ (discovery-service.jar)
                            sh """
                                scp -o StrictHostKeyChecking=no ${targetJar.path} ${REMOTE_USER}@${REMOTE_HOST}:${REMOTE_PATH}/discovery-service.jar
                            """
                        }
                    } else {
                        error("âŒ plainì´ ì•„ë‹Œ JAR íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
                    }
                }
            }
        }

        stage('Run Ansible Playbook') {
            steps {
                echo 'ğŸš€ Ansible í”Œë ˆì´ë¶ ì‹¤í–‰ ì¤‘...'
                sshagent (credentials: ["${SSH_CREDENTIALS_ID}"]) {
                    sh """
                        ssh -o StrictHostKeyChecking=no ${REMOTE_USER}@${REMOTE_HOST} \\
                        'ansible-playbook -i /ansible/inventory/hosts /ansible/playbooks/discovery-playbook/discovery-playbook.yml'
                    """
                }
            }
        }
    }

    post {
        success {
            echo 'âœ… discovery-service ë°°í¬ ì™„ë£Œ!'
        }
        failure {
            echo 'âŒ ë¹Œë“œ ë˜ëŠ” ë°°í¬ ì‹¤íŒ¨!'
        }
    }
}

def hasChangesIn(String dir) {
    return sh(
        script: "git diff --name-only HEAD~1 HEAD | grep ^${dir}/ || true",
        returnStdout: true
    ).trim() != ""
}